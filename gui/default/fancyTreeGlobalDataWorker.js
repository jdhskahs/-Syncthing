const generatedByTreeSelector = "// Generated by tree selector";

var ignores = [];
var invalidPattern = false;

// To prevent running multiple jobs at once.
// When new job starts old one cancel itself.
var latestReqId = 0;

self.onmessage = function (msg) {
	console.log("fancyTreeGlobalDataWorker | start", "data", msg.data)
	const newReqId = Date.now();
	latestReqId = newReqId;

	// Just cancellation message.
	if (!msg.data?.data) {
		console.log("fancyTreeGlobalDataWorker | cancel requested")
		return;
	}

	ignores = msg.data.ignorePatterns;
	if (ignores[0] !== generatedByTreeSelector) {
		invalidPattern = true;
		ignores = [];
	} else {
		ignores = ignores.slice(1, -1)
	}
	self.postMessage({
		data: formatGlobalTreeNodes(msg.data.data, "", newReqId),
		invalidPattern: invalidPattern
	});
	inProgress = false;
	console.log("fancyTreeGlobalDataWorker | finished");
}

function formatGlobalTreeNodes(data, parentKey, reqId, parentIgnored = true) {
	if (reqId != latestReqId) {
		console.log("fancyTreeGlobalDataWorker | cancelled", reqId)
		return null;
	}

	var result = [];
	// console.log("formatGlobalTreeNodes(worker)", "data", data, "parentKey", parentKey, "parentIgnored", parentIgnored)
	data.forEach(function(node) {
		const isFolder = node.type == "FILE_INFO_TYPE_DIRECTORY";
		const key = parentKey + "/" + node.name;
		const found = ignores.find(function (ignoreKey) {
			return key == ignoreKey.slice(1);
		});

		const ignored = parentIgnored && !found;
		result.push({
			children: isFolder && node.children?.length > 0 ? formatGlobalTreeNodes(node.children, key, reqId, ignored) : [],
			key: key,
			title: node.name,
			folder: isFolder,
			selected: !ignored
		});
		if (reqId != latestReqId) {
			console.log("fancyTreeGlobalDataWorker | cancelled", reqId)
			return null;
		}
	});

	return result;
}
